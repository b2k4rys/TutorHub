<!DOCTYPE html>
<html>
<head>
    <title>Chat Room</title>
    <style>
        body { font-family: sans-serif; padding: 1em; max-width: 800px; margin: auto; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; }
        #chat-log { list-style-type: none; padding: 0; margin: 0; height: 400px; overflow-y: scroll; border: 1px solid #ccc; margin-bottom: 10px; border-radius: 5px; }
        #chat-log li { padding: 8px 12px; }
        #chat-log li:nth-child(odd) { background-color: #f9f9f9; }
        #chat-controls { display: flex; }
        #chat-message-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px 0 0 5px; }
        #chat-message-send { padding: 10px 20px; border: 1px solid #007bff; background-color: #007bff; color: white; border-radius: 0 5px 5px 0; cursor: pointer; }
        #status { font-style: italic; color: #555; margin-bottom: 1em; }
        #conversation-id-display { font-size: 0.8em; color: #777; }
    </style>
</head>
<body>
    <h2>Chat Room</h2>
    <p id="conversation-id-display">Conversation ID: {{ conversation_id }}</p>

    <p id="status">Status: Initializing...</p>
    <ul id="chat-log"></ul>
    <div id="chat-controls">
        <input id="chat-message-input" type="text" placeholder="Enter message...">
        <button id="chat-message-send">Send</button>
    </div>

<script>
    // The page now only needs to know the unique conversation ID
    const conversationId = "{{ conversation_id }}";

    const statusDisplay = document.querySelector('#status');
    const chatLog = document.querySelector('#chat-log');
    const messageInput = document.querySelector('#chat-message-input');
    const sendButton = document.querySelector('#chat-message-send');
    let chatSocket = null;

    function logMessage(message, from = "System") {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${from}:</strong> ${message}`;
        chatLog.appendChild(li);
        chatLog.scrollTop = chatLog.scrollHeight; // Auto-scroll
    }

    // This function will get a ticket and then connect to the WebSocket
    async function setupChat() {
        statusDisplay.textContent = "Status: Getting authentication ticket...";
        
        try {
            // Step 1: Get the ticket from your API
            const jwtToken = prompt("Please paste your JWT access token to get a ticket:");
            if (!jwtToken) {
                statusDisplay.textContent = "Status: Auth token not provided. Connection cancelled.";
                return;
            }

            const ticketResponse = await fetch('/api/ws-ticket/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${jwtToken}`,
                    'Content-Type': 'application/json',
                },
            });

            if (!ticketResponse.ok) {
                throw new Error("Failed to get WebSocket ticket.");
            }

            const ticketData = await ticketResponse.json();
            const ticket = ticketData.ticket;
            
            // Step 2: Use the ticket to connect to the correct, unique conversation URL
            statusDisplay.textContent = "Status: Connecting to chat...";
            const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
            const wsUrl = `${wsScheme}://${window.location.host}/ws/chat/${conversationId}/?ticket=${ticket}`;
            
            chatSocket = new WebSocket(wsUrl);

            chatSocket.onopen = function(e) {
                statusDisplay.textContent = `Status: Connected.`;
                messageInput.focus();
            };

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                logMessage(data.message, data.sender_name);
            };

            chatSocket.onclose = function(e) {
                statusDisplay.textContent = "Status: Disconnected.";
            };

        } catch (error) {
            statusDisplay.textContent = `Status: Error - ${error.message}`;
            console.error("Chat setup failed:", error);
        }
    }

    sendButton.onclick = function() {
        if (!chatSocket) return;
        const message = messageInput.value;
        if (message.trim() === '') return;
        chatSocket.send(JSON.stringify({ 'message': message }));
        messageInput.value = '';
    };

    messageInput.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            sendButton.click();
        }
    });

    // Start the connection process when the page loads
    setupChat();
</script>
</body>
</html>
